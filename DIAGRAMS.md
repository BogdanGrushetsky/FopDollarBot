# 📊 Візуалізація роботи FOP Dollar Bot

## 🔄 Потік роботи бота

```
┌─────────────────────────────────────────────────────────────────┐
│                         Користувач                               │
│                    (Telegram User ID)                            │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Перевірка доступу                             │
│              (ALLOWED_USER_ID з .env)                            │
│     ❌ Відмова │                              ✅ Дозволено      │
└──────────────┴──────────────────────────────────┬───────────────┘
                                                    │
                                                    ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Головне меню                                │
│  ┌─────────────┐  ┌─────────────┐  ┌────────────┐              │
│  │ ➕ Додати USD│  │💰 Продати USD│  │ 📊 Статус │              │
│  └─────────────┘  └─────────────┘  └────────────┘              │
│              ┌────────────┐                                      │
│              │ ❓ Довідка │                                      │
│              └────────────┘                                      │
└─────────────────────────────────────────────────────────────────┘
```

## 💰 Додавання доходу (/add_usd)

```
Користувач: /add_usd 100 2026-02-01
                │
                ▼
    ┌───────────────────────┐
    │  Валідація даних      │
    │  • Сума > 0           │
    │  • Формат дати OK     │
    │  • Дата не в майбутньому│
    └───────┬───────────────┘
            │
            ▼
    ┌───────────────────────┐
    │ CurrencyService       │◄──────┐
    │ getNbuRate()          │       │
    └───────┬───────────────┘       │
            │                        │
            ▼                        │
    ┌───────────────────────┐       │
    │ Перевірка кешу        │       │
    │ (CurrencyCache)       │       │
    └───────┬───────────────┘       │
            │                        │
       ┌────┴────┐                  │
       │ Знайдено?│                 │
       └────┬────┘                  │
    Так │   │ Ні                    │
        │   │                       │
        │   └───► API НБУ ──────────┘
        │         Зберегти в кеш
        ▼
    ┌───────────────────────┐
    │ Розрахунки            │
    │ taxBase = $100 × 40.5 │
    │ = 4050 грн            │
    └───────┬───────────────┘
            │
            ▼
    ┌───────────────────────┐
    │ MongoDB               │
    │ UsdIncome.save()      │
    │ • amountUsd: 100      │
    │ • remainingUsd: 100   │
    │ • nbuRate: 40.5       │
    │ • taxBaseUah: 4050    │
    └───────┬───────────────┘
            │
            ▼
    ┌───────────────────────┐
    │ Відповідь користувачу │
    │ ✅ Дохід додано       │
    │ 💵 $100               │
    │ 📈 40.5 грн           │
    │ 💼 База: 4050 грн     │
    └───────────────────────┘
```

## 💸 Продаж USD (/sell_usd) з FIFO

```
Користувач: /sell_usd 120 2026-02-10
                │
                ▼
    ┌───────────────────────┐
    │ Перевірка балансу     │
    │ getBalance(userId)    │
    └───────┬───────────────┘
            │
     ┌──────┴──────┐
     │ Достатньо?  │
     └──────┬──────┘
      Ні    │ Так
      │     │
      │     ▼
      │ ┌───────────────────────┐
      │ │ CurrencyService       │
      │ │ getMonobankSellRate() │
      │ └───────┬───────────────┘
      │         │
      │         ▼
      │ ┌───────────────────────┐
      │ │ FIFO Logic            │
      │ │ ┌─────────────────────┤
      │ │ │ Партія 1: 100 USD   │
      │ │ │ date: 2026-02-01    │
      │ │ │ nbuRate: 40.5       │
      │ │ │ remaining: 100      │
      │ │ ├─────────────────────┤
      │ │ │ Партія 2: 50 USD    │
      │ │ │ date: 2026-02-05    │
      │ │ │ nbuRate: 41.0       │
      │ │ │ remaining: 50       │
      │ │ └─────────────────────┘
      │ └───────┬───────────────┘
      │         │
      │         ▼
      │ ┌───────────────────────┐
      │ │ Списання по FIFO      │
      │ │ 1. З Партії 1: 100 USD│
      │ │    база: 4050 грн     │
      │ │    remaining: 0       │
      │ │ 2. З Партії 2: 20 USD │
      │ │    база: 820 грн      │
      │ │    remaining: 30      │
      │ │ ─────────────────────│
      │ │ Загальна база: 4870грн│
      │ └───────┬───────────────┘
      │         │
      │         ▼
      │ ┌───────────────────────┐
      │ │ Розрахунок P&L        │
      │ │ sellUah = 120 × 42.0  │
      │ │ = 5040 грн            │
      │ │ profit = 5040 - 4870  │
      │ │ = +170 грн 💰         │
      │ └───────┬───────────────┘
      │         │
      │         ▼
      │ ┌───────────────────────┐
      │ │ MongoDB               │
      │ │ UsdSale.save()        │
      │ │ • amountUsd: 120      │
      │ │ • sellUah: 5040       │
      │ │ • taxBaseUah: 4870    │
      │ │ • profit: +170        │
      │ └───────┬───────────────┘
      │         │
      ▼         ▼
    ❌ Відмова   ✅ Успіх
```

## 📊 Статус (/status)

```
Користувач: /status
        │
        ▼
┌───────────────────────┐
│ UsdService.getStatus()│
└───────┬───────────────┘
        │
        ▼
┌───────────────────────┐
│ Збір даних з партій   │
│ ┌─────────────────────┤
│ │ Партія 2 (залишок)  │
│ │ remaining: 30 USD   │
│ │ nbuRate: 41.0       │
│ │ taxBase: 1230 грн   │
│ └─────────────────────┘
└───────┬───────────────┘
        │
        ▼
┌───────────────────────┐
│ Отримати курс Monobank│
│ getCurrentRate()      │
│ → 42.5 грн            │
└───────┬───────────────┘
        │
        ▼
┌───────────────────────┐
│ Розрахунки            │
│ • Balance: 30 USD     │
│ • Tax base: 1230 грн  │
│ • Current: 30×42.5    │
│   = 1275 грн          │
│ • Unrealized P&L:     │
│   1275 - 1230         │
│   = +45 грн 💰        │
└───────┬───────────────┘
        │
        ▼
┌───────────────────────┐
│ Відповідь користувачу │
│ 📊 Ваш статус         │
│ 💵 Баланс: $30        │
│ 📋 База: 1230 грн     │
│ 💱 Вартість: 1275 грн │
│ 💰 P&L: +45 грн       │
└───────────────────────┘
```

## 🗄️ Структура MongoDB

```
MongoDB Atlas
    │
    ├─ usd_incomes
    │   ├─ { userId, amountUsd, remainingUsd, nbuRate, ... }
    │   ├─ { userId, amountUsd, remainingUsd, nbuRate, ... }
    │   └─ ...
    │
    ├─ usd_sales
    │   ├─ { userId, amountUsd, sellUah, profit, ... }
    │   ├─ { userId, amountUsd, sellUah, profit, ... }
    │   └─ ...
    │
    └─ currency_caches
        ├─ { provider: 'nbu', date, rate, expiresAt }
        ├─ { provider: 'monobank', date, rate, expiresAt }
        └─ ... (автоматичне видалення через 6 міс.)
```

## 🔐 Безпека

```
Запит → ┌──────────────────┐
        │ Перевірка UserID │
        └────────┬─────────┘
                 │
          ┌──────┴──────┐
          │ ID == ALLOWED?│
          └──────┬──────┘
           Ні    │ Так
           │     │
           ▼     ▼
        ❌ Відмова  ✅ Виконання команди
```

## ⚡ Кеш курсів

```
Запит курсу
    │
    ▼
┌─────────────┐
│ Шукати кеш  │
└─────┬───────┘
      │
 ┌────┴────┐
 │ Знайдено?│
 └────┬────┘
      │
┌─────┴─────┐
│ Так │  Ні │
└──┬──┴──┬──┘
   │     │
   │     ▼
   │  ┌──────────┐
   │  │ API call │
   │  └────┬─────┘
   │       │
   │       ▼
   │  ┌──────────┐
   │  │ Save cache│
   │  │ TTL: 6 міс│
   │  └────┬─────┘
   │       │
   └───────┴─────► Повернути курс
```

---

## 📈 Приклад повного циклу

```
День 1 (01.02.2026): /add_usd 100 2026-02-01
  ├─ Курс НБУ: 40.5 грн
  ├─ База: 4050 грн
  └─ Баланс: $100

День 5 (05.02.2026): /add_usd 50 2026-02-05
  ├─ Курс НБУ: 41.0 грн
  ├─ База: 2050 грн
  └─ Баланс: $150 (100+50)

День 10 (10.02.2026): /sell_usd 120 2026-02-10
  ├─ Курс Monobank: 42.0 грн
  ├─ FIFO: 100 з партії 1 + 20 з партії 2
  ├─ База: 4050 + 820 = 4870 грн
  ├─ Продаж: 120 × 42.0 = 5040 грн
  ├─ Прибуток: 5040 - 4870 = +170 грн 💰
  └─ Баланс: $30 (50-20 з партії 2)

День 10 (10.02.2026): /status
  ├─ Баланс: $30
  ├─ База: 1230 грн (30 × 41.0)
  ├─ Вартість: 1275 грн (30 × 42.5 поточний)
  └─ Нереалізований: +45 грн 💰
```

---

**Візуалізація показує повний цикл роботи бота з усіма деталями!** 🎯
